<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minigame Quay Thưởng</title>
    <link rel="stylesheet" href="style.css" />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="Favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="Favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="Favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="Favicon/site.webmanifest" />
  </head>
  <body>
    <audio id="spinSound" src="spin.mp3" preload="auto"></audio>
    <audio id="winSound" src="reward.mp3" preload="auto"></audio>
    <div class="main-wrapper">
      <div class="header-text">
        <h3>KHÓI – Câu lạc bộ Múa NTH</h3>
        <h1>Minigame</h1>
      </div>

      <div class="game-box" style="width: 850px; max-width: 95%">
        <div
          class="slot-machine"
          style="justify-content: space-between; gap: 10px"
        >
          <div class="reel" style="width: 23%">
            <div class="reel-strip" id="reel1"></div>
          </div>
          <div class="reel" style="width: 23%">
            <div class="reel-strip" id="reel2"></div>
          </div>
          <div class="reel" style="width: 23%">
            <div class="reel-strip" id="reel3"></div>
          </div>
          <div class="reel" style="width: 23%">
            <div class="reel-strip" id="reel4"></div>
          </div>
        </div>

        <div class="control-area">
          <button class="spin-btn" onclick="spin()">QUAY</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="resultModal">
      <div class="modal-content">
        <h2 class="modal-title">Chúc mừng!</h2>
        <div class="result-container" id="resultContainer"></div>
        <button class="close-btn" onclick="closeModal()">Chơi tiếp</button>
      </div>
    </div>

    <script>
      // --- CẤU HÌNH ---
      const iconHeight = 100;
      const timePerSpin = 4000;
      const reelHeight = 200;
      const centerOffset = (reelHeight - iconHeight) / 2;

      // 1. Danh sách trái cây (10 loại)
      const fruitList = [
        "FRUITS/avocado.png",
        "FRUITS/banana.png",
        "FRUITS/blueberry.png",
        "FRUITS/boba-tea.png",
        "FRUITS/carrot.png",
        "FRUITS/cheese-block.png",
        "FRUITS/cherries.png",
        "FRUITS/chilli-pepper.png",
        "FRUITS/chocolate-bar.png",
        "FRUITS/clover.png",
        "FRUITS/coconut.png",
        "FRUITS/corn.png",
        "FRUITS/croissant.png",
        "FRUITS/cupcake.png",
        "FRUITS/donut.png",
        "FRUITS/eggplant.png",
        "FRUITS/flowers.png",
        "FRUITS/french-fries.png",
        "FRUITS/grapes.png",
        "FRUITS/greenapple.png",
        "FRUITS/hamburger.png",
        "FRUITS/hot-dog.png",
        "FRUITS/ice-cream.png",
        "FRUITS/kiwi.png",
        "FRUITS/lemon.png",
        "FRUITS/lolipop.png",
        "FRUITS/mushroom.png",
        "FRUITS/orange.png",
        "FRUITS/peach.png",
        "FRUITS/peanuts.png",
        "FRUITS/pineapple.png",
        "FRUITS/pizza.png",
        "FRUITS/popcorn.png",
        "FRUITS/redapple.png",
        "FRUITS/rose.png",
        "FRUITS/sandwich.png",
        "FRUITS/strawberry-cake.png",
        "FRUITS/strawberry.png",
        "FRUITS/sunflower.png",
        "FRUITS/tulip.png",
        "FRUITS/watermelon.png",
        "FRUITS/hoacuc.png",
      ];

      // 2. Danh sách có ô trống (Index 0 là BLANK, Index 1-10 là trái cây)
      const fruitListWithBlank = ["BLANK", ...fruitList];

      // Cấu hình 4 cột
      // Yêu cầu 1: currentIndex để là 1 (Táo) để lúc đầu không hiện ô trống
      const reelsConfig = [
        { id: "reel1", data: fruitListWithBlank, currentIndex: 1 },
        { id: "reel2", data: fruitListWithBlank, currentIndex: 1 },
        { id: "reel3", data: fruitListWithBlank, currentIndex: 1 },
        { id: "reel4", data: fruitList, currentIndex: 0 },
      ];

      // --- HÀM TẠO GIAO DIỆN ---
      const generateStripHTML = (data) => {
        let html = "";
        for (let i = 0; i < 20; i++) {
          data.forEach((item) => {
            if (item === "BLANK") {
              html += `<div class="fruit-img" style="height: ${iconHeight}px;"></div>`;
            } else {
              html += `<img src="${item}" class="fruit-img">`;
            }
          });
        }
        return html;
      };

      reelsConfig.forEach((config) => {
        const el = document.getElementById(config.id);
        el.innerHTML = generateStripHTML(config.data);
        const startY = -(config.currentIndex * iconHeight) + centerOffset;
        el.style.transform = `translateY(${startY}px)`;
      });

      // --- HÀM QUAY (LOGIC MỚI: ĐỒNG BỘ TRÁI CÂY) ---
      function spin() {
        const btn = document.querySelector(".spin-btn");

        // --- ÂM THANH: Lấy thẻ audio ---
        const spinSound = document.getElementById("spinSound");
        const winSound = document.getElementById("winSound");

        btn.disabled = true;

        // --- ÂM THANH: Xử lý bắt đầu quay ---
        winSound.pause(); // Dừng nhạc thắng nếu đang chạy
        winSound.currentTime = 0;
        spinSound.currentTime = 0;
        spinSound
          .play()
          .catch((e) => console.log("Cần tương tác để phát nhạc")); // Bắt lỗi nếu trình duyệt chặn

        // BƯỚC 1: Chọn ra "Trái cây chủ đạo" của lượt quay này (Random từ 0-9)
        const targetFruitIndex = Math.floor(Math.random() * fruitList.length);

        // Tính toán index tương ứng trong danh sách có ô trống
        // Vì 'BLANK' ở vị trí 0, nên trái cây sẽ bị đẩy lên 1 bậc (index + 1)
        const targetIndexInBlankList = targetFruitIndex + 1;

        reelsConfig.forEach((config, i) => {
          const el = document.getElementById(config.id);
          const totalItems = config.data.length;

          // BƯỚC 2: Quyết định kết quả cho từng cột
          let nextIndex;

          if (i === 3) {
            // Cột 4 (Cuối cùng): Bắt buộc ra trái cây chủ đạo
            nextIndex = targetFruitIndex;
          } else {
            // Cột 1, 2, 3: Random tỷ lệ xuất hiện
            // 60% ra Trái cây chủ đạo, 40% ra Ô trống
            const isFruit = Math.random() < 0.6;

            if (isFruit) {
              nextIndex = targetIndexInBlankList; // Ra trái cây (giống cột 4)
            } else {
              nextIndex = 0; // Ra ô trống (index 0 trong fruitListWithBlank)
            }
          }

          // --- Xử lý hiệu ứng quay (Giữ nguyên) ---
          const resetY = -(config.currentIndex * iconHeight) + centerOffset;
          el.style.transition = "none";
          el.style.transform = `translateY(${resetY}px)`;
          void el.offsetWidth;

          const loops = 10 + i * 3;
          const targetY =
            -(loops * totalItems * iconHeight + nextIndex * iconHeight) +
            centerOffset;

          el.style.transition = `transform ${timePerSpin}ms cubic-bezier(0.25, 1, 0.5, 1)`;
          el.style.transform = `translateY(${targetY}px)`;

          config.currentIndex = nextIndex;
        });

        // Hiện Popup
        setTimeout(() => {
          // --- ÂM THANH: Xử lý khi dừng quay ---
          spinSound.pause(); // Tắt tiếng quay
          winSound.play(); // Bật tiếng thắng

          showResultModal();
          btn.disabled = false;
        }, timePerSpin);
      }

      // --- XỬ LÝ POPUP (Yêu cầu 2: Bỏ ô trống) ---
      function showResultModal() {
        const modal = document.getElementById("resultModal");
        const container = document.getElementById("resultContainer");
        container.innerHTML = "";

        reelsConfig.forEach((config) => {
          const resultItem = config.data[config.currentIndex];

          // Nếu là ô trống thì bỏ qua ngay, không vẽ gì cả
          if (resultItem === "BLANK") return;

          // Vẽ trái cây
          const img = document.createElement("img");
          img.src = resultItem;
          img.className = "result-img";
          img.style.width = "150px";
          img.style.height = "150px";
          img.style.margin = "0 10px";
          container.appendChild(img);
        });

        modal.classList.add("active");
      }

      function closeModal() {
        const modal = document.getElementById("resultModal");

        // --- ÂM THANH: Tắt nhạc thắng khi đóng modal (Tuỳ chọn) ---
        const winSound = document.getElementById("winSound");
        winSound.pause();
        winSound.currentTime = 0;

        modal.classList.remove("active");
      }
    </script>
  </body>
</html>
